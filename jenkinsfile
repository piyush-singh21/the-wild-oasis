pipeline {
    agent any
    stages {
        stage('Stop Existing App') {
            steps {
                script {
                    // Check if the application is running on the specified port
                    def port = 9000
                    def isRunning = bat(script: "powershell -Command \"Get-NetTCPConnection -LocalPort ${port}\"", returnStatus: true) == 0
                    if (isRunning) {
                        // Stop and remove the running Docker container
                        bat 'docker stop wild-oasis-cont || exit 0'
                        bat 'docker rm wild-oasis-cont || exit 0'
                    } else {
                        echo "No application is running on port ${port}."
                    }
                }
            }
        }
        stage('Build') {
            steps {
                // Pull latest code and build the application
                dir('https://github.com/piyush-singh21/the-wild-oasis') { // Adjust to your actual code directory
                    bat 'git pull origin master'
                    // Uncomment these if you need to install dependencies and build
                    // bat 'npm install'
                    // bat 'npm run build'
                    bat 'docker build -t wild-oasis .'
                }
            }
        }
        stage('Run App') {
            steps {
                // Start the application again
                bat 'docker run --name wild-oasis-cont -d -p 9000:8080 wild-oasis'
            }
        }
    }
    post {
        always {
            echo 'Pipeline finished.'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
